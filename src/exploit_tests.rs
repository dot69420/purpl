#[cfg(test)]
mod tests {
    use crate::exploit::{build_searchsploit_command, extract_services_from_content, run_exploit_search};
    use crate::executor::MockExecutor;
    use crate::io_handler::MockIoHandler;
    use std::process::Output;
    use std::os::unix::process::ExitStatusExt;

    #[test]
    fn test_run_exploit_search_logic() {
        let executor = MockExecutor::new();
        let io = MockIoHandler::new();

        // 1. Version check output
        executor.add_output(Output {
            status: ExitStatusExt::from_raw(0),
            stdout: Vec::new(),
            stderr: Vec::new(),
        });

        run_exploit_search("invalid_path.xml", false, &executor, &io);

        let out = io.get_output();
        assert!(out.contains("Could not find Nmap XML report"));
    }

    #[test]
    fn test_run_exploit_search_full_flow() {
        let executor = MockExecutor::new();
        let io = MockIoHandler::new();

        // Create dummy XML
        let xml_content = r#"
        <nmaprun>
            <host>
                <ports>
                    <port portid="80" protocol="tcp">
                        <service name="http" product="Apache" version="2.4"/>
                    </port>
                </ports>
            </host>
        </nmaprun>
        "#;
        let file_path = "test_scan.xml";
        std::fs::write(file_path, xml_content).unwrap();

        // 1. Version check
        executor.add_output(Output {
             status: ExitStatusExt::from_raw(0),
             stdout: Vec::new(),
             stderr: Vec::new(),
        });

        // 2. Searchsploit execution output (JSON)
        let search_out = r#"{
            "RESULTS_EXPLOIT": [
                {
                    "Title": "Apache Exploit",
                    "Path": "exploits/1.py",
                    "Type": "remote"
                }
            ]
        }"#;

        executor.add_output(Output {
             status: ExitStatusExt::from_raw(0),
             stdout: search_out.as_bytes().to_vec(),
             stderr: Vec::new(),
        });

        run_exploit_search(file_path, false, &executor, &io);

        // Cleanup
        let _ = std::fs::remove_file(file_path);

        let out = io.get_output();
        assert!(out.contains("Found 1 services"));
        assert!(out.contains("Apache Exploit"));
    }

    #[test]
    fn test_build_searchsploit_command() {
        let (cmd, args) = build_searchsploit_command("searchsploit", "Apache", "2.4.49");
        assert_eq!(cmd, "searchsploit");
        assert!(args.contains(&"--json".to_string()));
        assert!(args.contains(&"Apache".to_string()));
        assert!(args.contains(&"2.4.49".to_string()));
    }

    #[test]
    fn test_extract_services_from_content() {
        let xml = r#"
        <nmaprun>
            <host>
                <ports>
                    <port portid="80" protocol="tcp">
                        <service name="http" product="Apache httpd" version="2.4.49"/>
                    </port>
                </ports>
            </host>
        </nmaprun>
        "#;

        let services = extract_services_from_content(xml);
        assert_eq!(services.len(), 1);
        assert_eq!(services[0].product, "Apache httpd");
        assert_eq!(services[0].version, "2.4.49");
        assert_eq!(services[0].port, "80");
    }
}
