#[cfg(test)]
mod tests {
    use crate::search_exploit::{extract_services_from_content, run_searchsploit};
    use crate::executor::MockExecutor;
    use crate::io_handler::MockIoHandler;


    #[test]
    fn test_run_exploit_search_logic() {
        let executor = MockExecutor::new();
        let io = MockIoHandler::new();

        // 1. Version check output
        executor.register_success("searchsploit");
        
        // Queue "q" to exit the loop after the first pass
        io.add_input("q\n");

        run_searchsploit("direct_search_term", false, &executor, &io);

        let out = io.get_output();
        // It should now try to direct search, not fail finding XML
        assert!(out.contains("Performing direct search"));
    }

    #[test]
    fn test_run_exploit_search_full_flow() {
        let executor = MockExecutor::new();
        let io = MockIoHandler::new();

        // Queue "q" to exit the loop after the auto-scan finishes
        io.add_input("q\n");

        // Create dummy XML
        let xml_content = r#"
        <nmaprun>
            <host>
                <ports>
                    <port portid="80" protocol="tcp">
                        <service name="http" product="Apache" version="2.4"/>
                    </port>
                </ports>
            </host>
        </nmaprun>
        "#;
        let file_path = "test_scan.xml";
        std::fs::write(file_path, xml_content).unwrap();

        // 1. Searchsploit execution output (JSON)
        let search_out = r#"{
            "RESULTS_EXPLOIT": [
                {
                    "Title": "Apache Exploit",
                    "Path": "exploits/1.py",
                    "Type": "remote"
                }
            ]
        }"#;

        executor.register_output("searchsploit", search_out.as_bytes());

        run_searchsploit(file_path, false, &executor, &io);

        // Cleanup
        let _ = std::fs::remove_file(file_path);

        let out = io.get_output();
        assert!(out.contains("Found 1 services"));
        assert!(out.contains("Apache Exploit"));
    }

    #[test]
    fn test_extract_services_from_content() {
        let xml = r#"
        <nmaprun>
            <host>
                <ports>
                    <port portid="80" protocol="tcp">
                        <service name="http" product="Apache httpd" version="2.4.49"/>
                    </port>
                </ports>
            </host>
        </nmaprun>
        "#;

        let services = extract_services_from_content(xml);
        assert_eq!(services.len(), 1);
        assert_eq!(services[0].product, "Apache httpd");
        assert_eq!(services[0].version, "2.4.49");
        assert_eq!(services[0].port, "80");
    }
}
